<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Manager Fixes Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        .test-container {
            display: flex;
            gap: 20px;
        }
        .controls {
            width: 200px;
        }
        .canvas-container {
            width: 800px;
            height: 600px;
            border: 2px solid #333;
            background: white;
            position: relative;
        }
        button {
            display: block;
            width: 100%;
            margin: 10px 0;
            padding: 10px;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .color-picker {
            width: 100%;
            height: 40px;
            margin: 10px 0;
        }
        .info {
            background: #e9ecef;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Canvas Manager Fixes Test</h1>
    <p>This test verifies:</p>
    <ul>
        <li><strong>Fit to screen</strong>: Should scale up small canvases to use available space</li>
        <li><strong>Background color</strong>: Should set container background instead of creating rect</li>
        <li><strong>LayerManager integration</strong>: CanvasManager should use LayerManager's main layer</li>
    </ul>
    
    <div class="test-container">
        <div class="controls">
            <h3>Canvas Controls</h3>
            
            <button onclick="createSmallCanvas()">Create Small Canvas (400x400)</button>
            <button onclick="createLargeCanvas()">Create Large Canvas (1200x1200)</button>
            <button onclick="fitToScreen()">Fit to Screen</button>
            <button onclick="resetZoom()">Reset Zoom</button>
            
            <h4>Background Color</h4>
            <input type="color" class="color-picker" value="#ffffff" onchange="setBackgroundColor(this.value)">
            
            <button onclick="addTestLayer()">Add Test Layer</button>
            <button onclick="clearLayers()">Clear Layers</button>
            <button onclick="exportCanvas()">Export as PNG</button>
            
            <div class="info">
                <strong>Current State:</strong><br>
                <div id="state-info">Not initialized</div>
            </div>
        </div>
        
        <div class="canvas-container" id="canvas-container">
            <!-- Canvas will be created here -->
        </div>
    </div>

    <script src="https://unpkg.com/konva@9/konva.min.js"></script>
    <script>
        class SimpleCanvasManager {
            constructor(container, width, height) {
                this.container = container
                this.originalWidth = width
                this.originalHeight = height
                
                // Clear container
                container.innerHTML = ''
                
                // Create Konva stage
                this.stage = new Konva.Stage({
                    container: container,
                    width: width,
                    height: height
                })
                
                // Create main layer (simulating LayerManager)
                this.mainLayer = new Konva.Layer()
                this.stage.add(this.mainLayer)
                
                this.updateStateInfo()
            }
            
            setSize(width, height) {
                this.stage.width(width)
                this.stage.height(height)
                this.originalWidth = width
                this.originalHeight = height
                this.updateStateInfo()
            }
            
            setBackgroundColor(color) {
                // CORRECT APPROACH: Create background rect on canvas layer (will be included in exports)
                if (!this.backgroundRect) {
                    this.backgroundRect = new Konva.Rect({
                        x: 0,
                        y: 0,
                        width: this.originalWidth,
                        height: this.originalHeight,
                        fill: color,
                        listening: false,
                        name: 'canvas-background'
                    })
                    
                    // Add to main layer and move to bottom for proper layering
                    this.mainLayer.add(this.backgroundRect)
                    this.backgroundRect.moveToBottom()
                    this.mainLayer.batchDraw()
                    
                    console.log('‚úÖ Background rect created on canvas layer (will be included in export)')
                } else {
                    this.backgroundRect.fill(color)
                    this.mainLayer.batchDraw()
                    console.log('‚úÖ Background color updated (will be included in export)')
                }
            }
            
            fitCanvasToViewport() {
                const containerRect = this.container.getBoundingClientRect()
                const availableWidth = containerRect.width
                const availableHeight = containerRect.height
                
                const canvasWidth = this.originalWidth
                const canvasHeight = this.originalHeight
                
                // Reduced padding to maximize canvas usage
                const padding = 50
                const targetWidth = Math.max(availableWidth - padding * 2, 200)
                const targetHeight = Math.max(availableHeight - padding * 2, 150)
                
                // Calculate scale
                const scaleX = targetWidth / canvasWidth
                const scaleY = targetHeight / canvasHeight
                let scale = Math.min(scaleX, scaleY)
                
                // FIXED: Allow scaling up to 3x (no longer limited to 1x)
                scale = Math.min(scale, 3)
                scale = Math.max(scale, 0.1)
                
                console.log('üîç Fit to viewport calculation:', {
                    availableViewport: { width: availableWidth, height: availableHeight },
                    canvasSize: { width: canvasWidth, height: canvasHeight },
                    targetSize: { width: targetWidth, height: targetHeight },
                    scaleCalculations: { scaleX, scaleY, finalScale: scale },
                    padding,
                    willScale: scale < 1 ? 'down' : scale > 1 ? 'up' : 'same'
                })
                
                // Center the canvas
                const scaledCanvasWidth = canvasWidth * scale
                const scaledCanvasHeight = canvasHeight * scale
                
                const x = (availableWidth - scaledCanvasWidth) / 2
                const y = (availableHeight - scaledCanvasHeight) / 2
                
                this.stage.scale({ x: scale, y: scale })
                this.stage.position({ x, y })
                
                this.updateStateInfo()
            }
            
            resetZoom() {
                this.stage.scale({ x: 1, y: 1 })
                this.stage.position({ x: 0, y: 0 })
                this.updateStateInfo()
            }
            
            addTestLayer() {
                // Add a test rectangle to the main layer (simulating LayerManager integration)
                const rect = new Konva.Rect({
                    x: Math.random() * (this.originalWidth - 100),
                    y: Math.random() * (this.originalHeight - 100),
                    width: 100,
                    height: 100,
                    fill: `hsl(${Math.random() * 360}, 70%, 50%)`,
                    stroke: '#333',
                    strokeWidth: 2
                })
                
                this.mainLayer.add(rect)
                this.mainLayer.batchDraw()
                
                console.log('‚úÖ Test layer added to main layer')
            }
            
            clearLayers() {
                this.mainLayer.removeChildren()
                this.mainLayer.batchDraw()
                console.log('‚úÖ All layers cleared from main layer')
            }
            
            updateStateInfo() {
                const scale = this.stage.scaleX()
                const pos = this.stage.position()
                const stageSize = { width: this.stage.width(), height: this.stage.height() }
                
                document.getElementById('state-info').innerHTML = `
                    Canvas: ${this.originalWidth}√ó${this.originalHeight}<br>
                    Stage: ${stageSize.width}√ó${stageSize.height}<br>
                    Scale: ${scale.toFixed(2)}x<br>
                    Position: (${pos.x.toFixed(0)}, ${pos.y.toFixed(0)})<br>
                    Layers: ${this.mainLayer.children.length}
                `
            }
        }
        
        let canvasManager = null
        
        function createSmallCanvas() {
            canvasManager = new SimpleCanvasManager(
                document.getElementById('canvas-container'),
                400,  // Small canvas - should scale UP when fit to screen
                400
            )
            console.log('‚úÖ Small canvas created (400√ó400)')
        }
        
        function createLargeCanvas() {
            canvasManager = new SimpleCanvasManager(
                document.getElementById('canvas-container'),
                1200,  // Large canvas - should scale DOWN when fit to screen
                1200
            )
            console.log('‚úÖ Large canvas created (1200√ó1200)')
        }
        
        function fitToScreen() {
            if (!canvasManager) {
                alert('Create a canvas first!')
                return
            }
            canvasManager.fitCanvasToViewport()
            console.log('‚úÖ Fit to screen applied')
        }
        
        function resetZoom() {
            if (!canvasManager) {
                alert('Create a canvas first!')
                return
            }
            canvasManager.resetZoom()
            console.log('‚úÖ Zoom reset')
        }
        
        function setBackgroundColor(color) {
            if (!canvasManager) {
                alert('Create a canvas first!')
                return
            }
            canvasManager.setBackgroundColor(color)
        }
        
        function addTestLayer() {
            if (!canvasManager) {
                alert('Create a canvas first!')
                return
            }
            canvasManager.addTestLayer()
        }
        
        function clearLayers() {
            if (!canvasManager) {
                alert('Create a canvas first!')
                return
            }
            canvasManager.clearLayers()
        }
        
        // Create default small canvas to start
        createSmallCanvas()
    </script>
</body>
</html>
