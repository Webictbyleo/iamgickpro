# Nginx configuration for ImagePro Design Platform
# Production-ready configuration with security, performance optimizations, and frontend hosting
# Place this in /etc/nginx/sites-available/imagepro and symlink to sites-enabled

# Rate limiting zones (add to main nginx.conf http block if not exists)
limit_req_zone $binary_remote_addr zone=api:10m rate=30r/m;
limit_req_zone $binary_remote_addr zone=upload:10m rate=5r/m;
limit_req_zone $binary_remote_addr zone=auth:10m rate=10r/m;

# Upstream for PHP-FPM (for load balancing if needed)
upstream php_backend {
    server unix:/var/run/php/php8.4-fpm.sock;
    # server unix:/var/run/php/php8.4-fpm.sock backup; # Add more servers for load balancing
}

# HTTP to HTTPS redirect
server {
    listen 80;
    listen [::]:80;
    server_name your-domain.com www.your-domain.com;
    
    # Security headers even for redirects
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    
    # Redirect HTTP to HTTPS in production
    return 301 https://$server_name$request_uri;
}

# Main HTTPS server block
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name your-domain.com www.your-domain.com;
    
    # Document root for backend API
    root /var/www/html/iamgickpro/backend/public;
    index index.php;
    
    # SSL Configuration (Let's Encrypt recommended)
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_stapling on;
    ssl_stapling_verify on;
    
    # Document root for backend API
    root /var/www/html/iamgickpro/backend/public;
    index index.php;
    
    # SSL Configuration (Let's Encrypt recommended)
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_stapling on;
    ssl_stapling_verify on;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob: https:; font-src 'self' data:; connect-src 'self' https:; media-src 'self' blob:; object-src 'none'; frame-src 'none';" always;
    
    # Hide nginx version
    server_tokens off;
    
    # Client settings
    client_max_body_size 100M;
    client_body_timeout 60s;
    client_header_timeout 60s;
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types 
        text/plain
        text/css
        text/xml
        text/javascript
        text/x-component
        application/javascript
        application/json
        application/xml
        application/rss+xml
        application/atom+xml
        application/xhtml+xml
        application/x-font-ttf
        application/vnd.ms-fontobject
        font/opentype
        image/svg+xml
        image/x-icon;
    
    # Serve frontend static files
    location / {
        alias /var/www/html/iamgickpro/frontend/dist/;
        try_files $uri $uri/ /index.html;
        
        # Cache frontend assets
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            access_log off;
        }
        
        # Don't cache HTML files
        location ~* \.(html)$ {
            expires -1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
        }
    }
    
    # API endpoints - rate limited
    location /api/ {
        limit_req zone=api burst=60 nodelay;
        try_files $uri /index.php$is_args$args;
    }
    
    # Authentication endpoints - more restrictive rate limiting
    location ~* ^/api/(login|register|reset-password) {
        limit_req zone=auth burst=10 nodelay;
        try_files $uri /index.php$is_args$args;
    }
    
    # Upload endpoints - strictest rate limiting
    location /api/media/upload {
        limit_req zone=upload burst=5 nodelay;
        try_files $uri /index.php$is_args$args;
    }
    
    # Websocket support for real-time features (if implemented)
    location /ws/ {
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Health check endpoint
    location /health {
        access_log off;
        add_header Content-Type text/plain;
        return 200 "healthy\n";
    }
    
    # Direct serving of media files (for performance)
    location /media/ {
        alias /var/www/html/iamgickpro/backend/public/uploads/media/;
        
        # Cache media files
        expires 1M;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options "nosniff";
        access_log off;
        
        # Security: prevent execution of scripts
        location ~* \.(php|php3|php4|php5|phtml|pl|py|jsp|asp|sh|cgi)$ {
            deny all;
        }
        
        # Handle missing files gracefully
        try_files $uri @symfony;
    }
    
    # Direct serving of thumbnails (for performance) 
    location /thumbnails/ {
        alias /var/www/html/iamgickpro/backend/public/uploads/thumbnails/;
        
        # Cache thumbnails longer
        expires 1M;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options "nosniff";
        access_log off;
        
        # Security: prevent execution of scripts
        location ~* \.(php|php3|php4|php5|phtml|pl|py|jsp|asp|sh|cgi)$ {
            deny all;
        }
        
        # Handle missing files gracefully
        try_files $uri @symfony;
    }
    
    # Secure media serving (requires authentication)
    location /secure-media/ {
        # Always route through Symfony for authentication
        try_files $uri /index.php$is_args$args;
    }
    
    # PHP-FPM configuration
    location ~ ^/index\.php(/|$) {
        fastcgi_pass php_backend;
        fastcgi_split_path_info ^(.+\.php)(/.*)$;
        include fastcgi_params;
        
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
        fastcgi_param HTTPS on;
        
        # Security parameters
        fastcgi_param HTTP_PROXY "";
        
        # Performance settings
        fastcgi_read_timeout 300;
        fastcgi_send_timeout 300;
        fastcgi_connect_timeout 60;
        fastcgi_buffer_size 128k;
        fastcgi_buffers 4 256k;
        fastcgi_busy_buffers_size 256k;
        
        internal;
    }
    
    # Return 404 for other PHP files
    location ~ \.php$ {
        return 404;
    }
    
    # Symfony fallback for API routes
    location @symfony {
        rewrite ^(.+)$ /index.php$1 last;
    }
    
    # Security: Block access to sensitive files and directories
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    location ~ ^/(var|vendor|config|bin|migrations|tests|docs|scripts|storage)/ {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # Block access to composer and other config files
    location ~* \.(json|lock|md|yaml|yml|xml|dist)$ {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # Prevent access to upload directories for script execution
    location ~* ^/uploads/.*\.(php|php3|php4|php5|phtml|pl|py|jsp|asp|sh|cgi)$ {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # Deny access to version control
    location ~ /\.(git|svn|hg) {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # Block backup and temporary files
    location ~* \.(bak|tmp|temp|swp|old|orig)$ {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# Optional: API subdomain configuration
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name api.your-domain.com;
#     
#     # Same SSL configuration as main domain
#     ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
#     
#     root /var/www/html/iamgickpro/backend/public;
#     index index.php;
#     
#     # Only serve API endpoints
#     location / {
#         try_files $uri /index.php$is_args$args;
#     }
#     
#     # Same PHP-FPM configuration as main domain
#     location ~ ^/index\.php(/|$) {
#         fastcgi_pass php_backend;
#         fastcgi_split_path_info ^(.+\.php)(/.*)$;
#         include fastcgi_params;
#         fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
#         fastcgi_param DOCUMENT_ROOT $realpath_root;
#         fastcgi_param HTTPS on;
#         internal;
#     }
# }
