<!DOCTYPE html>
<html>
<head>
    <title>Canvas Integration Debug</title>
    <script src="https://unpkg.com/konva@9/konva.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #canvas-container {
            border: 2px solid #ddd;
            width: 800px;
            height: 600px;
            margin: 20px 0;
        }
        button {
            margin: 5px;
            padding: 10px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        #debug-info {
            margin-top: 20px;
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>Canvas Integration Debug Test</h1>
    <p>This test simulates the integration between Vue component and EditorSDK to debug element visibility issues.</p>
    
    <div>
        <button onclick="addRectangle()">Add Rectangle</button>
        <button onclick="addCircle()">Add Circle</button>
        <button onclick="addText()">Add Text</button>
        <button onclick="debugStage()">Debug Stage</button>
        <button onclick="debugLayers()">Debug Layers</button>
        <button onclick="centerView()">Center View</button>
        <button onclick="redraw()">Force Redraw</button>
    </div>
    
    <div id="canvas-container"></div>
    
    <div id="debug-info">Debug info will appear here...</div>

    <script>
        // Simulate the integration setup
        let stage = null;
        let mainLayer = null;
        let uiLayer = null;
        let layerCounter = 0;

        function log(message) {
            const debugInfo = document.getElementById('debug-info');
            debugInfo.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            console.log(message);
        }

        // Initialize canvas similar to how EditorSDK does it
        function initializeCanvas() {
            const container = document.getElementById('canvas-container');
            container.innerHTML = ''; // Clear existing content
            
            // Create stage
            stage = new Konva.Stage({
                container: container,
                width: 800,
                height: 600
            });
            
            // Create main layer for content
            mainLayer = new Konva.Layer();
            stage.add(mainLayer);
            
            // Create UI layer for transformers
            uiLayer = new Konva.Layer();
            stage.add(uiLayer);
            
            log('Canvas initialized');
            log(`Stage size: ${stage.width()}x${stage.height()}`);
            log(`Main layer added: ${mainLayer ? 'YES' : 'NO'}`);
            log(`UI layer added: ${uiLayer ? 'YES' : 'NO'}`);
            
            stage.batchDraw();
        }

        function addRectangle() {
            if (!stage || !mainLayer) {
                log('ERROR: Canvas not initialized');
                return;
            }
            
            layerCounter++;
            
            const rect = new Konva.Rect({
                x: Math.random() * 500 + 50,
                y: Math.random() * 400 + 50,
                width: 100,
                height: 80,
                fill: `hsl(${Math.random() * 360}, 70%, 50%)`,
                stroke: '#333',
                strokeWidth: 2,
                draggable: true,
                name: `rect-${layerCounter}`
            });
            
            mainLayer.add(rect);
            log(`Added rectangle ${layerCounter} at (${rect.x()}, ${rect.y()})`);
            log(`Rectangle size: ${rect.width()}x${rect.height()}`);
            log(`Rectangle visible: ${rect.visible()}`);
            log(`Main layer children count: ${mainLayer.children.length}`);
            
            // Force redraw
            mainLayer.batchDraw();
        }

        function addCircle() {
            if (!stage || !mainLayer) {
                log('ERROR: Canvas not initialized');
                return;
            }
            
            layerCounter++;
            
            const circle = new Konva.Circle({
                x: Math.random() * 500 + 100,
                y: Math.random() * 400 + 100,
                radius: 50,
                fill: `hsl(${Math.random() * 360}, 70%, 50%)`,
                stroke: '#333',
                strokeWidth: 2,
                draggable: true,
                name: `circle-${layerCounter}`
            });
            
            mainLayer.add(circle);
            log(`Added circle ${layerCounter} at (${circle.x()}, ${circle.y()})`);
            log(`Circle radius: ${circle.radius()}`);
            log(`Circle visible: ${circle.visible()}`);
            log(`Main layer children count: ${mainLayer.children.length}`);
            
            // Force redraw
            mainLayer.batchDraw();
        }

        function addText() {
            if (!stage || !mainLayer) {
                log('ERROR: Canvas not initialized');
                return;
            }
            
            layerCounter++;
            
            const text = new Konva.Text({
                x: Math.random() * 400 + 50,
                y: Math.random() * 300 + 50,
                text: `Text Element ${layerCounter}`,
                fontSize: 24,
                fill: '#333',
                draggable: true,
                name: `text-${layerCounter}`
            });
            
            mainLayer.add(text);
            log(`Added text ${layerCounter} at (${text.x()}, ${text.y()})`);
            log(`Text content: "${text.text()}"`);
            log(`Text visible: ${text.visible()}`);
            log(`Main layer children count: ${mainLayer.children.length}`);
            
            // Force redraw
            mainLayer.batchDraw();
        }

        function debugStage() {
            if (!stage) {
                log('ERROR: Stage not initialized');
                return;
            }
            
            log('=== STAGE DEBUG ===');
            log(`Stage container: ${stage.container()}`);
            log(`Stage size: ${stage.width()}x${stage.height()}`);
            log(`Stage position: (${stage.x()}, ${stage.y()})`);
            log(`Stage scale: ${stage.scaleX()}, ${stage.scaleY()}`);
            log(`Stage visible: ${stage.visible()}`);
            log(`Stage children count: ${stage.children.length}`);
            
            stage.children.forEach((layer, index) => {
                log(`  Layer ${index}: ${layer.name() || 'unnamed'} (${layer.children.length} children)`);
            });
        }

        function debugLayers() {
            if (!mainLayer) {
                log('ERROR: Main layer not initialized');
                return;
            }
            
            log('=== LAYER DEBUG ===');
            log(`Main layer children: ${mainLayer.children.length}`);
            
            mainLayer.children.forEach((child, index) => {
                log(`  Child ${index}: ${child.name() || 'unnamed'} (${child.className})`);
                log(`    Position: (${child.x()}, ${child.y()})`);
                log(`    Visible: ${child.visible()}`);
                log(`    Opacity: ${child.opacity()}`);
                
                if (child.className === 'Rect') {
                    log(`    Size: ${child.width()}x${child.height()}`);
                    log(`    Fill: ${child.fill()}`);
                } else if (child.className === 'Circle') {
                    log(`    Radius: ${child.radius()}`);
                    log(`    Fill: ${child.fill()}`);
                } else if (child.className === 'Text') {
                    log(`    Text: "${child.text()}"`);
                    log(`    Font size: ${child.fontSize()}`);
                }
            });
        }

        function centerView() {
            if (!stage) {
                log('ERROR: Stage not initialized');
                return;
            }
            
            stage.position({ x: 0, y: 0 });
            stage.scale({ x: 1, y: 1 });
            stage.batchDraw();
            log('View centered and reset to 100% zoom');
        }

        function redraw() {
            if (!stage) {
                log('ERROR: Stage not initialized');
                return;
            }
            
            stage.batchDraw();
            log('Force redraw completed');
        }

        // Initialize when page loads
        window.onload = function() {
            initializeCanvas();
        }
    </script>
</body>
</html>
